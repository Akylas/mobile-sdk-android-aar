buildscript {
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:8.12.1' // match your Gradle version
    }
}

plugins {
    id 'de.undercouch.download' version '5.1.1'
    id 'maven-publish'
}

// Configuration
def libVersion = project.findProperty("version") ?: System.getenv("VERSION") ?: ""
def aarUrlsProp = project.findProperty("aarUrls") ?: System.getenv("AAR_URLS") ?: ""
def variantsProp = project.findProperty("variants") ?: System.getenv("VARIANTS") ?: ""
def useClassifier = (project.findProperty("useClassifier") ?: System.getenv("USE_CLASSIFIER") ?: "true").toBoolean()

def baseGroup = project.findProperty("groupId") ?: System.getenv("GROUP_ID") ?: "com.github.Akylas"
def baseArtifact = project.findProperty("artifactId") ?: System.getenv("ARTIFACT_ID") ?: "mobile-sdk-android-aar"

if (!aarUrlsProp) {
    throw new GradleException("You must provide -PaarUrls=<comma-separated-urls-to-aars>")
}
if (!libVersion) {
    throw new GradleException("You must provide -Pversion=<version>")
}

def aarUrls = aarUrlsProp.split(',').collect { it.trim() }.findAll { it }
def variants = variantsProp ? variantsProp.split(',').collect { it.trim() }.findAll { it } : []

if (variants.size() == 0) {
    variants = aarUrls.collect { url ->
        def file = url.tokenize('/').last()
        def name = file.replaceAll(/\.aar$/, '').replaceAll(/[^A-Za-z0-9_\-]/, '_')
        return name ?: "variant"
    }
}

if (variants.size() != aarUrls.size()) {
    throw new GradleException("aarUrls and variants must have the same number of entries (or omit variants to auto-derive).")
}

def downloadsDir = layout.buildDirectory.dir("downloads")

aarUrls.eachWithIndex { url, idx ->
    def variant = variants[idx]
    def downloadedAar = downloadsDir.file("${variant}.aar")
    def downloadTaskName = "downloadExternalAar_${variant}"

    tasks.register(downloadTaskName, de.undercouch.gradle.tasks.download.Download) {
        src url
        dest downloadedAar
        onlyIfModified true
        doLast {
            println "Downloaded AAR for variant '${variant}': ${downloadedAar.get().asFile}, size: ${downloadedAar.get().asFile.length()} bytes"
        }
    }
}

// Single publication that attaches multiple artifacts (classifiers) to avoid GAV collisions
publishing {
    publications {
        create("release", MavenPublication) {
            groupId = baseGroup
            artifactId = baseArtifact
            version = libVersion

            // Attach first variant as default artifact for backward compatibility.
            // Also attach classifier artifacts for all variants (including the first).
            aarUrls.eachWithIndex { url, idx ->
                def variant = variants[idx]
                def downloadedAar = downloadsDir.file("${variant}.aar")
                def downloadTaskName = tasks.named("downloadExternalAar_${variant}")

                if (useClassifier) {
                    // For the first variant attach no-classifier main artifact (so old deps work)
                    if (idx == 0) {
                        artifact(downloadedAar) {
                            builtBy(downloadTaskName)
                            extension = 'aar'
                        }
                    }
                    // Attach as classifier (so consumers can request variant via classifier)
                    artifact(downloadedAar) {
                        builtBy(downloadTaskName)
                        extension = 'aar'
                        classifier = variant
                    }
                } else {
                    // If not using classifier, attach first as main artifact and create separate publications
                    if (idx == 0) {
                        artifact(downloadedAar) {
                            builtBy(downloadTaskName)
                            extension = 'aar'
                        }
                    } else {
                        // create separate publication for other variants with distinct artifactId
                        create(variant, MavenPublication) {
                            groupId = baseGroup
                            artifactId = "${baseArtifact}-${variant}"
                            version = libVersion
                            artifact(downloadedAar) {
                                builtBy(downloadTaskName)
                                extension = 'aar'
                            }
                        }
                    }
                }
            }
        }
    }

    repositories {
        maven {
            url = uri(System.getProperty("user.home") + "/.m2/repository")
        }
    }
}